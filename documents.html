<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เอกสารทางการแพทย์ - ระบบติดตามการรักษาโรคต้อหิน</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS styles */
        :root {
            --primary: #00A8A8;
            --primary-dark: #007878;
            --primary-light: #E0F2F1;
            --secondary: #00CECE;
            --dark: #324047;
            --gray: #6B7280;
            --light-gray: #F3F4F6;
            --white: #FFFFFF;
            --error: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --info: #3B82F6;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background-color: #F9FAFB;
            color: var(--dark);
            min-height: 100vh;
        }

        /* Layout */
        .layout {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--white);
            height: 100vh;
            position: fixed;
            box-shadow: var(--shadow);
            z-index: 10;
            transition: all 0.3s ease;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 20;
            background: var(--primary);
            color: var(--white);
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .logo-container {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            width: 50px;
            height: 50px;
            background-color: var(--primary-light);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 24px;
            font-weight: bold;
            margin-right: 12px;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .logo-subtitle {
            font-size: 12px;
            color: var(--gray);
        }

        .menu {
            padding: 20px 0;
            overflow-y: auto;
            max-height: calc(100vh - 91px);
        }

        .menu-label {
            padding: 0 20px;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--gray);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .menu-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        /* Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notifications-btn {
            background: var(--white);
            border: 1px solid var(--border);
            color: var(--gray);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .notifications-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 14px;
            height: 14px;
            background-color: var(--error);
            border-radius: 50%;
            border: 2px solid var(--white);
            display: none;
        }

        .user-dropdown {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 6px 8px 6px 6px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background-color: var(--primary-light);
            border-radius: 50%;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: 600;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            margin-right: 8px;
        }

        /* User Menu */
        .user-menu {
            position: absolute;
            right: 0;
            top: 50px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            width: 200px;
            z-index: 100;
            display: none;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border);
        }

        .user-menu-item:last-child {
            border-bottom: none;
        }

        .user-menu-item:hover {
            background-color: var(--light-gray);
        }

        .user-menu-logout {
            color: var(--error);
        }

        /* Card Styles */
        .card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-action {
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
        }

        .card-body {
            padding: 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Document Styles */
        .document-item {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .document-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary);
            border-radius: 8px;
            font-size: 24px;
        }

        .document-content {
            flex: 1;
        }

        .document-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .document-info {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 12px;
        }

        .document-date {
            font-size: 13px;
            color: var(--gray);
        }

        .document-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .document-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .document-btn.primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .document-btn.primary:hover {
            background-color: var(--primary-dark);
        }

        .document-btn.secondary {
            background-color: var(--light-gray);
            color: var(--dark);
        }

        .document-btn.secondary:hover {
            background-color: var(--border);
        }

        /* Search and Filter */
        .search-container {
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input-container {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 168, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 18px;
        }

        .filter-select {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            color: var(--dark);
            background-color: var(--white);
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 168, 0.1);
        }

        .filter-btn {
            padding: 12px 16px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-btn:hover {
            background-color: var(--primary-dark);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 15px;
            margin-bottom: 16px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 24px;
            gap: 8px;
        }

        .pagination-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--white);
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover {
            background-color: var(--light-gray);
        }

        .pagination-btn.active {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 168, 168, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 16px;
        }

        .loading-text {
            font-size: 15px;
            color: var(--gray);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Document Viewer Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .modal {
            width: 100%;
            max-width: 90%;
            height: 90vh;
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-actions {
            display: flex;
            gap: 8px;
        }

        .modal-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .modal-btn.primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .modal-btn.secondary {
            background-color: var(--light-gray);
            color: var(--dark);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 18px;
            color: var(--gray);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background-color: var(--gray);
            color: var(--white);
        }

        .modal-body {
            flex: 1;
            overflow: auto;
            padding: 0;
            position: relative;
        }

        .document-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .document-content-wrapper {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .document-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .document-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .document-meta {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .document-section {
            margin-bottom: 24px;
        }

        .document-section h2 {
            font-size: 18px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .document-section p {
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .document-table th {
            background-color: var(--light-gray);
            padding: 10px;
            text-align: left;
            border: 1px solid var(--border);
        }

        .document-table td {
            padding: 10px;
            border: 1px solid var(--border);
        }

        .document-image {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 16px;
            display: block;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .document-image-caption {
            text-align: center;
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 24px;
        }

        .document-charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 24px;
        }

        .document-chart {
            flex: 1;
            min-width: 300px;
            height: 300px;
            background-color: var(--light-gray);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
        }

        /* API Error */
        .api-error {
            background-color: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            display: none;
        }

        .api-error-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--error);
            flex-shrink: 0;
        }

        .api-error-content {
            flex: 1;
        }

        .api-error-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .api-error-message {
            font-size: 14px;
            color: var(--gray);
        }

        .api-error-retry {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background-color: var(--error);
            color: var(--white);
            transition: all 0.3s ease;
        }

        .api-error-retry:hover {
            background-color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main-content {
                margin-left: 0;
                padding-top: 60px;
            }
            
            .document-charts {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 8px;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            .document-item {
                flex-direction: column;
            }
            
            .document-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .document-btn {
                justify-content: center;
            }
            
            .pagination {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
    
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo-container">
                <div class="logo">G</div>
                <div class="logo-text">
                    <div class="logo-title">GTMS</div>
                    <div class="logo-subtitle">ระบบติดตามการรักษาโรคต้อหิน</div>
                </div>
            </div>
            
            <nav class="menu">
                <p class="menu-label">หน้าหลัก</p>
                <a href="dashboard.html" class="menu-item">
                    <div class="menu-icon">📊</div>
                    แดชบอร์ด
                </a>
                <a href="appointments.html" class="menu-item">
                    <div class="menu-icon">📅</div>
                    การนัดหมาย
                </a>
                
                <p class="menu-label">การติดตามการรักษา</p>
                <a href="iop-tracking.html" class="menu-item">
                    <div class="menu-icon">👁️</div>
                    ค่าความดันลูกตา
                </a>
                <a href="medications.html" class="menu-item">
                    <div class="menu-icon">💊</div>
                    ยาและการรักษา
                </a>
                <a href="eye-tests.html" class="menu-item">
                    <div class="menu-icon">📝</div>
                    ผลการตรวจวัด
                </a>
                
                <p class="menu-label">อื่นๆ</p>
                <a href="profile.html" class="menu-item">
                    <div class="menu-icon">👤</div>
                    ข้อมูลส่วนตัว
                </a>
                <a href="notifications.html" class="menu-item">
                    <div class="menu-icon">🔔</div>
                    การแจ้งเตือน
                </a>
                <a href="documents.html" class="menu-item active">
                    <div class="menu-icon">📄</div>
                    เอกสารทางการแพทย์
                </a>
                <a href="settings.html" class="menu-item">
                    <div class="menu-icon">⚙️</div>
                    ตั้งค่า
                </a>
                <a href="#" class="menu-item" onclick="logout()">
                    <div class="menu-icon">🚪</div>
                    ออกจากระบบ
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- API Error Display -->
            <div class="api-error" id="apiError">
                <div class="api-error-icon">⚠️</div>
                <div class="api-error-content">
                    <div class="api-error-title">ไม่สามารถโหลดข้อมูลได้</div>
                    <div class="api-error-message" id="apiErrorMessage">กรุณาลองใหม่อีกครั้ง</div>
                </div>
                <button class="api-error-retry" onclick="loadData()">ลองใหม่</button>
            </div>

            <div class="content-header">
                <h1 class="page-title">เอกสารทางการแพทย์</h1>
                
                <div class="user-info">
                    <button class="notifications-btn" onclick="location.href='notifications.html'">
                        🔔
                        <span class="notifications-indicator" id="notificationsIndicator"></span>
                    </button>
                    
                    <div class="user-dropdown" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="headerUserAvatar">-</div>
                        <span class="user-name" id="headerUserName">กำลังโหลด...</span>
                        <span>▼</span>
                    </div>

                    <!-- User Menu Dropdown -->
                    <div class="user-menu" id="userMenu">
                        <a href="profile.html" class="user-menu-item">
                            <div class="menu-icon">👤</div>
                            โปรไฟล์
                        </a>
                        <a href="settings.html" class="user-menu-item">
                            <div class="menu-icon">⚙️</div>
                            ตั้งค่า
                        </a>
                        <a href="#" class="user-menu-item user-menu-logout" onclick="logout()">
                            <div class="menu-icon">🚪</div>
                            ออกจากระบบ
                        </a>
                    </div>
                </div>
            </div>

            <!-- Document Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="visual-field" onclick="switchTab('visual-field')">ผลการตรวจลานสายตา</div>
                <div class="tab" data-tab="fundus" onclick="switchTab('fundus')">ผลการถ่ายจอประสาทตา</div>
            </div>

            <!-- Search and Filter -->
            <div class="search-container">
                <div class="search-row">
                    <div class="search-input-container">
                        <span class="search-icon">🔍</span>
                        <input type="text" class="search-input" id="search-input" placeholder="ค้นหาเอกสาร...">
                    </div>
                    <select class="filter-select" id="date-filter">
                        <option value="all">ทุกช่วงเวลา</option>
                        <option value="last-month">1 เดือนล่าสุด</option>
                        <option value="last-3-months">3 เดือนล่าสุด</option>
                        <option value="last-6-months">6 เดือนล่าสุด</option>
                        <option value="last-year">1 ปีล่าสุด</option>
                    </select>
                    <select class="filter-select" id="doctor-filter">
                        <option value="all">แพทย์ทั้งหมด</option>
                        <!-- จะเติมข้อมูลจาก API -->
                    </select>
                    <select class="filter-select" id="hospital-filter">
                        <option value="all">สถานพยาบาลทั้งหมด</option>
                        <!-- จะเติมข้อมูลจาก API -->
                    </select>
                    <button class="filter-btn" onclick="applyFilters()">กรอง</button>
                </div>
            </div>

            <!-- Visual Field Documents Tab -->
            <div id="visual-field-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">เอกสารผลการตรวจลานสายตา</h2>
                    </div>
                    <div class="card-body">
                        <!-- Loading Spinner -->
                        <div class="loading-container" id="visual-field-loading">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">กำลังโหลดข้อมูล...</p>
                        </div>
                        
                        <div id="visual-field-container" style="display: none;">
                            <!-- Visual Field documents will be loaded here -->
                        </div>
                        
                        <!-- Empty State -->
                        <div class="empty-state" id="visual-field-empty" style="display: none;">
                            <div class="empty-state-icon">📄</div>
                            <div class="empty-state-text">ไม่พบเอกสารผลการตรวจลานสายตา</div>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="pagination" id="visual-field-pagination" style="display: none;">
                            <button class="pagination-btn" onclick="changePage('visual-field', 'prev')">◀</button>
                            <button class="pagination-btn active">1</button>
                            <button class="pagination-btn">2</button>
                            <button class="pagination-btn">3</button>
                            <button class="pagination-btn" onclick="changePage('visual-field', 'next')">▶</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fundus Documents Tab -->
            <div id="fundus-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">เอกสารผลการถ่ายจอประสาทตา</h2>
                    </div>
                    <div class="card-body">
                        <!-- Loading Spinner -->
                        <div class="loading-container" id="fundus-loading">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">กำลังโหลดข้อมูล...</p>
                        </div>
                        
                        <div id="fundus-container" style="display: none;">
                            <!-- Fundus documents will be loaded here -->
                        </div>
                        
                        <!-- Empty State -->
                        <div class="empty-state" id="fundus-empty" style="display: none;">
                            <div class="empty-state-icon">📄</div>
                            <div class="empty-state-text">ไม่พบเอกสารผลการถ่ายจอประสาทตา</div>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="pagination" id="fundus-pagination" style="display: none;">
                            <button class="pagination-btn" onclick="changePage('fundus', 'prev')">◀</button>
                            <button class="pagination-btn active">1</button>
                            <button class="pagination-btn">2</button>
                            <button class="pagination-btn">3</button>
                            <button class="pagination-btn" onclick="changePage('fundus', 'next')">▶</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Document Viewer Modal -->
    <div class="modal-backdrop" id="documentViewerModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="documentViewerTitle">ชื่อเอกสาร</h2>
                <div class="modal-actions">
                    <button class="modal-btn secondary" onclick="printDocument()">
                        <span>🖨️</span> พิมพ์
                    </button>
                    <button class="modal-btn primary" onclick="downloadDocument()">
                        <span>⬇️</span> ดาวน์โหลด
                    </button>
                    <button class="modal-close" onclick="closeModal('documentViewerModal')">×</button>
                </div>
            </div>
            <div class="modal-body" id="documentViewerContent">
                <!-- Document content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Configuration
        // แทนที่ <script> ทั้งหมดในไฟล์ documents.html ด้วยโค้ดนี้

const API_BASE_URL = 'http://localhost:5001/api'; // ใช้ API เดียวกับที่มี
let patientData = null;
let visualFieldDocuments = [];
let fundusDocuments = [];
let currentTab = 'visual-field';
let currentPage = {
    'visual-field': 1,
    'fundus': 1
};
let totalPages = {
    'visual-field': 1,
    'fundus': 1
};
let doctors = [];
let hospitals = [];
let currentFilters = {
    search: '',
    dateFilter: 'all',
    doctorFilter: 'all',
    hospitalFilter: 'all'
};

// === Authentication Functions ===
function checkAuth() {
    const token = localStorage.getItem('gtms_token');
    if (!token) {
        window.location.href = 'index.html';
        return false;
    }
    return token;
}

async function fetchWithAuth(url, options = {}) {
    const token = checkAuth();
    if (!token) throw new Error("No authentication token");
    
    const defaultOptions = {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    };
    
    const mergedOptions = {
        ...defaultOptions,
        ...options,
        headers: { ...defaultOptions.headers, ...options.headers }
    };
    
    const response = await fetch(url, mergedOptions);
    
    if (!response.ok) {
        if (response.status === 401) {
            await logout();
            throw new Error("Session expired");
        }
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return response.json();
}

async function logout() {
    const token = checkAuth();
    if (token) {
        try {
            await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
    }
    localStorage.clear();
    window.location.href = 'index.html';
}

// === UI Helper Functions ===
function showApiError(message) {
    const apiError = document.getElementById('apiError');
    const apiErrorMessage = document.getElementById('apiErrorMessage');
    if (apiErrorMessage) apiErrorMessage.textContent = message;
    if (apiError) apiError.style.display = 'flex';
}

function hideApiError() {
    const apiError = document.getElementById('apiError');
    if (apiError) apiError.style.display = 'none';
}

function updateUserUI() {
    if (!patientData) return;
    
    const headerUserName = document.getElementById('headerUserName');
    const headerUserAvatar = document.getElementById('headerUserAvatar');
    
    if (headerUserName && headerUserAvatar) {
        const displayName = patientData.firstName && patientData.lastName 
            ? `${patientData.firstName} ${patientData.lastName}` 
            : patientData.username || 'ผู้ใช้';
        
        headerUserName.textContent = displayName;
        headerUserAvatar.textContent = displayName.charAt(0).toUpperCase();
    }
}

function toggleUserMenu() {
    const userMenu = document.getElementById('userMenu');
    if (userMenu) userMenu.classList.toggle('show');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) sidebar.classList.toggle('open');
}

function formatThaiDate(date) {
    if (!date) return '-';
    try {
        const d = new Date(date);
        const day = d.getDate();
        const monthNames = [
            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ];
        const month = monthNames[d.getMonth()];
        const year = d.getFullYear() + 543;
        return `${day} ${month} ${year}`;
    } catch (e) {
        return date;
    }
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getGenderText(gender) {
    switch (gender) {
        case 'male': return 'ชาย';
        case 'female': return 'หญิง';
        case 'other': return 'อื่นๆ';
        default: return '-';
    }
}

function calculateAge(birthDate) {
    if (!birthDate) return '-';
    
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    return `${age} ปี`;
}

// === Load User Profile ===
async function loadUserProfile() {
    const token = checkAuth();
    if (!token) return;
    
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/auth/me`);
        
        if (response.user) {
            patientData = response.user;
            updateUserUI();
            await loadData();
            await loadDoctorsAndHospitals();
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
        showApiError('ไม่สามารถโหลดข้อมูลผู้ใช้ได้');
    }
}

// === Load Doctors and Hospitals ===
async function loadDoctorsAndHospitals() {
    try {
        // พยายามโหลดข้อมูลแพทย์จาก API (ถ้ามี)
        try {
            const doctorsData = await fetchWithAuth(`${API_BASE_URL}/doctors`);
            doctors = doctorsData.doctors || [];
        } catch (error) {
            console.warn('Could not load doctors:', error);
            doctors = [];
        }
        
        // พยายามโหลดข้อมูลโรงพยาบาลจาก API (ถ้ามี)
        try {
            const hospitalsData = await fetchWithAuth(`${API_BASE_URL}/hospitals`);
            hospitals = hospitalsData.hospitals || [];
        } catch (error) {
            console.warn('Could not load hospitals:', error);
            hospitals = [];
        }
        
        updateFiltersOptions();
    } catch (error) {
        console.warn('Error loading filters data:', error);
    }
}

function updateFiltersOptions() {
    // อัปเดตตัวเลือกแพทย์
    const doctorFilter = document.getElementById('doctor-filter');
    if (doctorFilter) {
        doctorFilter.innerHTML = '<option value="all">แพทย์ทั้งหมด</option>';
        
        if (doctors.length > 0) {
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id || doctor.doctor_id;
                option.textContent = `${doctor.title || 'นพ.'}${doctor.first_name || doctor.firstName} ${doctor.last_name || doctor.lastName}`;
                doctorFilter.appendChild(option);
            });
        }
    }
    
    // อัปเดตตัวเลือกโรงพยาบาล
    const hospitalFilter = document.getElementById('hospital-filter');
    if (hospitalFilter) {
        hospitalFilter.innerHTML = '<option value="all">สถานพยาบาลทั้งหมด</option>';
        
        if (hospitals.length > 0) {
            hospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital.id || hospital.hospital_id;
                option.textContent = hospital.name;
                hospitalFilter.appendChild(option);
            });
        }
    }
}

// === Tab Management ===
function switchTab(tab) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(`${tab}-tab`);
    if (selectedTab) selectedTab.style.display = 'block';
    
    // Update active tab
    document.querySelectorAll('.tab').forEach(tabEl => {
        tabEl.classList.remove('active');
    });
    const activeTab = document.querySelector(`.tab[data-tab="${tab}"]`);
    if (activeTab) activeTab.classList.add('active');
    
    currentTab = tab;
    loadData();
}

// === Load Data ===
async function loadData() {
    if (!patientData?.id) {
        await loadUserProfile();
        return;
    }
    
    hideApiError();
    
    try {
        if (currentTab === 'visual-field') {
            await loadVisualFieldDocuments();
        } else if (currentTab === 'fundus') {
            await loadFundusDocuments();
        }
    } catch (error) {
        console.error(`Error loading ${currentTab} data:`, error);
        showApiError(`เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`);
    }
}

// === Visual Field Documents ===
async function loadVisualFieldDocuments() {
    const loadingEl = document.getElementById('visual-field-loading');
    const containerEl = document.getElementById('visual-field-container');
    const emptyEl = document.getElementById('visual-field-empty');
    const paginationEl = document.getElementById('visual-field-pagination');
    
    if (loadingEl) loadingEl.style.display = 'flex';
    if (containerEl) containerEl.style.display = 'none';
    if (emptyEl) emptyEl.style.display = 'none';
    if (paginationEl) paginationEl.style.display = 'none';
    
    // สร้าง query parameters
    const page = currentPage['visual-field'];
    let queryParams = `page=${page}`;
    
    if (currentFilters.search) {
        queryParams += `&search=${encodeURIComponent(currentFilters.search)}`;
    }
    if (currentFilters.dateFilter !== 'all') {
        queryParams += `&date_filter=${encodeURIComponent(currentFilters.dateFilter)}`;
    }
    if (currentFilters.doctorFilter !== 'all') {
        queryParams += `&doctor_id=${encodeURIComponent(currentFilters.doctorFilter)}`;
    }
    if (currentFilters.hospitalFilter !== 'all') {
        queryParams += `&hospital_id=${encodeURIComponent(currentFilters.hospitalFilter)}`;
    }
    
    try {
        const data = await fetchWithAuth(`${API_BASE_URL}/patient/documents?document_type=visual-field&${queryParams}`);
        visualFieldDocuments = data.documents || [];
        totalPages['visual-field'] = data.total_pages || 1;
        
        if (loadingEl) loadingEl.style.display = 'none';
        
        if (visualFieldDocuments.length === 0) {
            if (emptyEl) emptyEl.style.display = 'block';
        } else {
            renderVisualFieldDocuments();
            updatePagination('visual-field');
        }
    } catch (error) {
        console.error('Error loading visual field documents:', error);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
        showApiError('ไม่สามารถโหลดเอกสารผลการตรวจลานสายตาได้');
    }
}

function renderVisualFieldDocuments() {
    const container = document.getElementById('visual-field-container');
    if (!container) return;
    
    container.style.display = 'block';
    container.innerHTML = '';
    
    visualFieldDocuments.forEach(doc => {
        const documentItem = document.createElement('div');
        documentItem.className = 'document-item';
        
        // หาชื่อแพทย์
        let doctorName = 'ไม่ระบุแพทย์';
        if (doc.doctor_id && doctors.length > 0) {
            const doctor = doctors.find(d => (d.id || d.doctor_id) === doc.doctor_id);
            if (doctor) {
                doctorName = `${doctor.title || 'นพ.'}${doctor.first_name || doctor.firstName} ${doctor.last_name || doctor.lastName}`;
            }
        }
        
        // หาชื่อโรงพยาบาล
        let hospitalName = 'ไม่ระบุสถานพยาบาล';
        if (doc.hospital_id && hospitals.length > 0) {
            const hospital = hospitals.find(h => (h.id || h.hospital_id) === doc.hospital_id);
            if (hospital) {
                hospitalName = hospital.name;
            }
        }
        
        documentItem.innerHTML = `
            <div class="document-icon">📊</div>
            <div class="document-content">
                <div class="document-title">${doc.document_title || doc.title || 'ผลการตรวจลานสายตา'}</div>
                <div class="document-info">
                    <strong>แพทย์:</strong> ${doctorName} | 
                    <strong>สถานพยาบาล:</strong> ${hospitalName}
                </div>
                <div class="document-info">
                    <strong>ประเภท:</strong> ${doc.document_type || 'Visual Field Test'} | 
                    <strong>ขนาดไฟล์:</strong> ${formatFileSize(doc.file_size)}
                </div>
                <div class="document-date">
                    <strong>วันที่อัปโหลด:</strong> ${formatThaiDate(doc.upload_date)} | 
                    <strong>วันที่สร้าง:</strong> ${formatThaiDate(doc.created_at)}
                </div>
                <div class="document-actions">
                    <button class="document-btn secondary" onclick="viewDocument('${doc.document_id}', 'visual-field')">
                        <span>👁️</span> ดูเอกสาร
                    </button>
                    <button class="document-btn primary" onclick="downloadDocument('${doc.document_id}')">
                        <span>⬇️</span> ดาวน์โหลด
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(documentItem);
    });
}

// === Fundus Documents ===
async function loadFundusDocuments() {
    const loadingEl = document.getElementById('fundus-loading');
    const containerEl = document.getElementById('fundus-container');
    const emptyEl = document.getElementById('fundus-empty');
    const paginationEl = document.getElementById('fundus-pagination');
    
    if (loadingEl) loadingEl.style.display = 'flex';
    if (containerEl) containerEl.style.display = 'none';
    if (emptyEl) emptyEl.style.display = 'none';
    if (paginationEl) paginationEl.style.display = 'none';
    
    const page = currentPage['fundus'];
    let queryParams = `page=${page}`;
    
    if (currentFilters.search) {
        queryParams += `&search=${encodeURIComponent(currentFilters.search)}`;
    }
    if (currentFilters.dateFilter !== 'all') {
        queryParams += `&date_filter=${encodeURIComponent(currentFilters.dateFilter)}`;
    }
    if (currentFilters.doctorFilter !== 'all') {
        queryParams += `&doctor_id=${encodeURIComponent(currentFilters.doctorFilter)}`;
    }
    if (currentFilters.hospitalFilter !== 'all') {
        queryParams += `&hospital_id=${encodeURIComponent(currentFilters.hospitalFilter)}`;
    }
    
    try {
        const data = await fetchWithAuth(`${API_BASE_URL}/patient/documents?document_type=fundus&${queryParams}`);
        fundusDocuments = data.documents || [];
        totalPages['fundus'] = data.total_pages || 1;
        
        if (loadingEl) loadingEl.style.display = 'none';
        
        if (fundusDocuments.length === 0) {
            if (emptyEl) emptyEl.style.display = 'block';
        } else {
            renderFundusDocuments();
            updatePagination('fundus');
        }
    } catch (error) {
        console.error('Error loading fundus documents:', error);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
        showApiError('ไม่สามารถโหลดเอกสารผลการถ่ายจอประสาทตาได้');
    }
}

function renderFundusDocuments() {
    const container = document.getElementById('fundus-container');
    if (!container) return;
    
    container.style.display = 'block';
    container.innerHTML = '';
    
    fundusDocuments.forEach(doc => {
        const documentItem = document.createElement('div');
        documentItem.className = 'document-item';
        
        let doctorName = 'ไม่ระบุแพทย์';
        if (doc.doctor_id && doctors.length > 0) {
            const doctor = doctors.find(d => (d.id || d.doctor_id) === doc.doctor_id);
            if (doctor) {
                doctorName = `${doctor.title || 'นพ.'}${doctor.first_name || doctor.firstName} ${doctor.last_name || doctor.lastName}`;
            }
        }
        
        let hospitalName = 'ไม่ระบุสถานพยาบาล';
        if (doc.hospital_id && hospitals.length > 0) {
            const hospital = hospitals.find(h => (h.id || h.hospital_id) === doc.hospital_id);
            if (hospital) {
                hospitalName = hospital.name;
            }
        }
        
        documentItem.innerHTML = `
            <div class="document-icon">📷</div>
            <div class="document-content">
                <div class="document-title">${doc.document_title || doc.title || 'ผลการถ่ายจอประสาทตา'}</div>
                <div class="document-info">
                    <strong>แพทย์:</strong> ${doctorName} | 
                    <strong>สถานพยาบาล:</strong> ${hospitalName}
                </div>
                <div class="document-info">
                    <strong>ประเภท:</strong> ${doc.document_type || 'Fundus Photography'} | 
                    <strong>ขนาดไฟล์:</strong> ${formatFileSize(doc.file_size)}
                </div>
                <div class="document-date">
                    <strong>วันที่อัปโหลด:</strong> ${formatThaiDate(doc.upload_date)} | 
                    <strong>วันที่สร้าง:</strong> ${formatThaiDate(doc.created_at)}
                </div>
                <div class="document-actions">
                    <button class="document-btn secondary" onclick="viewDocument('${doc.document_id}', 'fundus')">
                        <span>👁️</span> ดูเอกสาร
                    </button>
                    <button class="document-btn primary" onclick="downloadDocument('${doc.document_id}')">
                        <span>⬇️</span> ดาวน์โหลด
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(documentItem);
    });
}

// === Document Actions ===
async function viewDocument(documentId, type) {
    try {
        // หาข้อมูลเอกสาร
        let document;
        if (type === 'visual-field') {
            document = visualFieldDocuments.find(d => d.document_id === documentId);
        } else if (type === 'fundus') {
            document = fundusDocuments.find(d => d.document_id === documentId);
        }
        
        if (!document) {
            throw new Error('Document not found');
        }
        
        // ตั้งชื่อเอกสาร
        const modalTitle = document.getElementById('documentViewerTitle');
        if (modalTitle) {
            modalTitle.textContent = document.document_title || document.title || 
                (type === 'visual-field' ? 'ผลการตรวจลานสายตา' : 'ผลการถ่ายจอประสาทตา');
        }
        
        // สร้างเนื้อหาเอกสาร
        const modalContent = document.getElementById('documentViewerContent');
        if (modalContent) {
            if (type === 'visual-field') {
                createVisualFieldContent(modalContent, document);
            } else if (type === 'fundus') {
                createFundusContent(modalContent, document);
            }
        }
        
        // แสดง Modal
        const modal = document.getElementById('documentViewerModal');
        if (modal) modal.style.display = 'flex';
        
    } catch (error) {
        console.error('Error viewing document:', error);
        alert('ไม่สามารถแสดงเอกสารได้ กรุณาลองใหม่อีกครั้ง');
    }
}

function createVisualFieldContent(container, document) {
    const doctorName = findDoctorName(document.doctor_id);
    const hospitalName = findHospitalName(document.hospital_id);
    
    container.innerHTML = `
        <div class="document-content-wrapper">
            <div class="document-header">
                <h1>${document.document_title || document.title || 'ผลการตรวจลานสายตา'}</h1>
                <div class="document-meta">
                    <strong>วันที่อัปโหลด:</strong> ${formatThaiDate(document.upload_date)}
                </div>
                <div class="document-meta">
                    <strong>แพทย์ผู้ตรวจ:</strong> ${doctorName} | <strong>สถานพยาบาล:</strong> ${hospitalName}
                </div>
            </div>
            
            <div class="document-section">
                <h2>ข้อมูลทั่วไป</h2>
                <div class="document-table">
                    <table class="document-table">
                        <tr>
                            <th>ชื่อ-นามสกุล</th>
                            <td>${patientData.firstName || ''} ${patientData.lastName || ''}</td>
                            <th>เพศ</th>
                            <td>${getGenderText(patientData.gender)}</td>
                        </tr>
                        <tr>
                            <th>รหัสประจำตัวผู้ป่วย</th>
                            <td>${patientData.hn || patientData.id}</td>
                            <th>เบอร์โทรศัพท์</th>
                            <td>${patientData.phone || '-'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="document-section">
                <h2>รายละเอียดเอกสาร</h2>
                <div class="document-table">
                    <table class="document-table">
                        <tr>
                            <th>ประเภทเอกสาร</th>
                            <td>${document.document_type || 'Visual Field Test'}</td>
                            <th>ขนาดไฟล์</th>
                            <td>${formatFileSize(document.file_size)}</td>
                        </tr>
                        <tr>
                            <th>รายละเอียด</th>
                            <td colspan="3">${document.description || 'ไม่มีรายละเอียด'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="document-section">
                <h2>เอกสารต้นฉบับ</h2>
                <p>กรุณาดาวน์โหลดเอกสารเพื่อดูรายละเอียดทั้งหมด</p>
                <button class="document-btn primary" onclick="downloadDocument('${document.document_id}')">
                    <span>⬇️</span> ดาวน์โหลดเอกสาร
                </button>
            </div>
        </div>
    `;
}

function createFundusContent(container, document) {
    const doctorName = findDoctorName(document.doctor_id);
    const hospitalName = findHospitalName(document.hospital_id);
    
    container.innerHTML = `
        <div class="document-content-wrapper">
            <div class="document-header">
                <h1>${document.document_title || document.title || 'ผลการถ่ายจอประสาทตา'}</h1>
                <div class="document-meta">
                    <strong>วันที่อัปโหลด:</strong> ${formatThaiDate(document.upload_date)}
                </div>
                <div class="document-meta">
                    <strong>แพทย์ผู้ตรวจ:</strong> ${doctorName} | <strong>สถานพยาบาล:</strong> ${hospitalName}
                </div>
            </div>
            
            <div class="document-section">
                <h2>ข้อมูลทั่วไป</h2>
                <div class="document-table">
                    <table class="document-table">
                        <tr>
                            <th>ชื่อ-นามสกุล</th>
                            <td>${patientData.firstName || ''} ${patientData.lastName || ''}</td>
                            <th>เพศ</th>
                            <td>${getGenderText(patientData.gender)}</td>
                        </tr>
                        <tr>
                            <th>รหัสประจำตัวผู้ป่วย</th>
                            <td>${patientData.hn || patientData.id}</td>
                            <th>เบอร์โทรศัพท์</th>
                            <td>${patientData.phone || '-'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="document-section">
                <h2>รายละเอียดเอกสาร</h2>
                <div class="document-table">
                    <table class="document-table">
                        <tr>
                            <th>ประเภทเอกสาร</th>
                            <td>${document.document_type || 'Fundus Photography'}</td>
                            <th>ขนาดไฟล์</th>
                            <td>${formatFileSize(document.file_size)}</td>
                        </tr>
                        <tr>
                            <th>รายละเอียด</th>
                            <td colspan="3">${document.description || 'ไม่มีรายละเอียด'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="document-section">
                <h2>เอกสารต้นฉบับ</h2>
                <p>กรุณาดาวน์โหลดเอกสารเพื่อดูรายละเอียดทั้งหมด</p>
                <button class="document-btn primary" onclick="downloadDocument('${document.document_id}')">
                    <span>⬇️</span> ดาวน์โหลดเอกสาร
                </button>
            </div>
        </div>
    `;
}

function findDoctorName(doctorId) {
    if (!doctorId || doctors.length === 0) return 'ไม่ระบุแพทย์';
    const doctor = doctors.find(d => (d.id || d.doctor_id) === doctorId);
    return doctor ? `${doctor.title || 'นพ.'}${doctor.first_name || doctor.firstName} ${doctor.last_name || doctor.lastName}` : 'ไม่ระบุแพทย์';
}

function findHospitalName(hospitalId) {
    if (!hospitalId || hospitals.length === 0) return 'ไม่ระบุสถานพยาบาล';
    const hospital = hospitals.find(h => (h.id || h.hospital_id) === hospitalId);
    return hospital ? hospital.name : 'ไม่ระบุสถานพยาบาล';
}

async function downloadDocument(documentId) {
    const token = checkAuth();
    if (!token) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/patient/documents/${documentId}/download`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error('ไม่สามารถดาวน์โหลดเอกสารได้');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `document-${documentId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Download error:', error);
        alert('ไม่สามารถดาวน์โหลดเอกสารได้ กรุณาลองใหม่อีกครั้ง');
    }
}

function printDocument() {
    window.print();
}

// === Pagination Functions ===
function updatePagination(type) {
    const paginationContainer = document.getElementById(`${type}-pagination`);
    if (!paginationContainer) return;
    
    if (totalPages[type] <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'flex';
    
    let paginationHTML = `
        <button class="pagination-btn ${currentPage[type] === 1 ? 'disabled' : ''}" 
                onclick="changePage('${type}', 'prev')" 
                ${currentPage[type] === 1 ? 'disabled' : ''}>◀</button>
    `;
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage[type] - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages[type], startPage + maxVisiblePages - 1);
    
    if (endPage === totalPages[type]) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage[type] ? 'active' : ''}" 
                    onclick="changePage('${type}', ${i})">${i}</button>
        `;
    }
    
    paginationHTML += `
        <button class="pagination-btn ${currentPage[type] === totalPages[type] ? 'disabled' : ''}" 
                onclick="changePage('${type}', 'next')" 
                ${currentPage[type] === totalPages[type] ? 'disabled' : ''}>▶</button>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

function changePage(type, page) {
    if (page === 'prev') {
        if (currentPage[type] > 1) {
            currentPage[type]--;
        }
    } else if (page === 'next') {
        if (currentPage[type] < totalPages[type]) {
            currentPage[type]++;
        }
    } else {
        currentPage[type] = page;
    }
    
    if (type === 'visual-field') {
        loadVisualFieldDocuments();
    } else if (type === 'fundus') {
        loadFundusDocuments();
    }
}

// === Search and Filter Functions ===
function applyFilters() {
    const searchInput = document.getElementById('search-input');
    const dateFilter = document.getElementById('date-filter');
    const doctorFilter = document.getElementById('doctor-filter');
    const hospitalFilter = document.getElementById('hospital-filter');
    
    currentFilters = {
        search: searchInput ? searchInput.value : '',
        dateFilter: dateFilter ? dateFilter.value : 'all',
        doctorFilter: doctorFilter ? doctorFilter.value : 'all',
        hospitalFilter: hospitalFilter ? hospitalFilter.value : 'all'
    };
    
    // รีเซ็ตหน้าปัจจุบัน
    currentPage['visual-field'] = 1;
    currentPage['fundus'] = 1;
    
    // โหลดข้อมูลใหม่
    loadData();
}

// === Modal Functions ===
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'none';
}

// === Event Listeners ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('Documents page loaded');
    
    const token = checkAuth();
    if (token) {
        loadUserProfile();
    }
    
    // Set initial active tab
    currentTab = 'visual-field';
    const visualFieldTab = document.querySelector('.tab[data-tab="visual-field"]');
    const visualFieldContent = document.getElementById('visual-field-tab');
    
    if (visualFieldTab) visualFieldTab.classList.add('active');
    if (visualFieldContent) visualFieldContent.style.display = 'block';
    
    // Hide other tabs initially
    const fundusContent = document.getElementById('fundus-tab');
    if (fundusContent) fundusContent.style.display = 'none';
    
    // Search on Enter key
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const userMenu = document.getElementById('userMenu');
        const userDropdown = document.querySelector('.user-dropdown');
        
        if (userMenu && userMenu.classList.contains('show') && 
            userDropdown && !userDropdown.contains(event.target)) {
            userMenu.classList.remove('show');
        }
        
        // Close modals when clicking backdrop
        if (event.target.classList.contains('modal-backdrop')) {
            event.target.style.display = 'none';
        }
    });
    
    // Close modals with ESC key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const visibleModals = document.querySelectorAll('.modal-backdrop[style*="flex"]');
            visibleModals.forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
    
    console.log('Documents page initialization complete');
});
    </script>
</body>
</html>      